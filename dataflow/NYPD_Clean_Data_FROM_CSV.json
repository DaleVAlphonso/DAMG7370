{
	"name": "NYPD_Clean_Data_FROM_CSV",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "DelimitedTextCSV",
						"type": "DatasetReference"
					},
					"name": "readCSVfile"
				},
				{
					"dataset": {
						"referenceName": "DelimitedGeoCSV",
						"type": "DatasetReference"
					},
					"name": "GeographicalData"
				}
			],
			"sinks": [
				{
					"name": "s"
				}
			],
			"transformations": [
				{
					"name": "TransformToCleanData"
				},
				{
					"name": "JoinTable"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "RequiredColumns"
				}
			],
			"scriptLines": [
				"parameters{",
				"     Job_id_Param as string (\"60\")",
				"}",
				"source(output(",
				"          ARREST_KEY as integer,",
				"          ARREST_DATE as date 'MM/dd/yyyy',",
				"          PD_CD as integer,",
				"          PD_DESC as string,",
				"          KY_CD as integer,",
				"          OFNS_DESC as string,",
				"          LAW_CODE as string,",
				"          LAW_CAT_CD as string,",
				"          ARREST_BORO as string,",
				"          ARREST_PRECINCT as integer,",
				"          JURISDICTION_CODE as integer,",
				"          AGE_GROUP as string,",
				"          PERP_SEX as string,",
				"          PERP_RACE as string,",
				"          X_COORD_CD as integer,",
				"          Y_COORD_CD as integer,",
				"          Latitude as double,",
				"          Longitude as double,",
				"          {New Georeferenced Column} as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> readCSVfile",
				"source(output(",
				"          ARREST_BORO as string,",
				"          ARREST_PRECINCT as integer,",
				"          MedianNo0_X_COORD_CD as integer,",
				"          MedianNo0_Y_COORD_CD as integer,",
				"          MedianNo0_Latitude as double,",
				"          MedianNo0_Longitude as double",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> GeographicalData",
				"readCSVfile derive(PD_CD = iif(or(isNull(PD_CD),PD_CD== 0),-1,PD_CD),",
				"          PD_DESC = iif(PD_DESC == '(null)', 'NO DESCRIPTION', PD_DESC),",
				"          KY_CD = iif(or(isNull(KY_CD),KY_CD== 0),-1,KY_CD),",
				"          OFNS_DESC = iif(OFNS_DESC == '(null)', 'NO DESCRIPTION', OFNS_DESC),",
				"          LAW_CAT_CD = iif(isNull(LAW_CAT_CD), \"UNKNOWN\",iif(LAW_CAT_CD == \"F\", \"Felony\",iif(LAW_CAT_CD == \"M\", \"Misdemeanor\",iif(LAW_CAT_CD == \"V\", \"Violation\", \"UNKNOWN\")\r",
				"        )\r",
				"    )\r",
				"),",
				"          ARREST_BORO = iif(ARREST_BORO == \"B\", \"BRONX\",\r",
				"    iif(ARREST_BORO == \"S\", \"STATEN ISLAND\",\r",
				"        iif(ARREST_BORO == \"K\", \"BROOKLYN\",\r",
				"            iif(ARREST_BORO == \"M\", \"MANHATTAN\",\r",
				"                iif(ARREST_BORO == \"Q\", \"QUEENS\", \"UNKNOWN\")\r",
				"            )\r",
				"        )\r",
				"    )\r",
				"),",
				"          Latitude = iif(isNull(Latitude) , toDouble(0), Latitude),",
				"          Longitude = iif(isNull(Longitude), toDouble(0), Longitude),",
				"          X_COORD_CD = iif(isNull(X_COORD_CD), toInteger(0), X_COORD_CD),",
				"          Y_COORD_CD = iif(isNull(Y_COORD_CD), toInteger(0), Y_COORD_CD),",
				"          {New Georeferenced Column} = iif(or(isNull({New Georeferenced Column}),{New Georeferenced Column} == \"\"),\"NULL\",{New Georeferenced Column})) ~> TransformToCleanData",
				"TransformToCleanData, GeographicalData join(TransformToCleanData@ARREST_BORO == GeographicalData@ARREST_BORO",
				"     && readCSVfile@ARREST_PRECINCT == GeographicalData@ARREST_PRECINCT,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JoinTable",
				"JoinTable derive(X_COORD_CD = iif(or(isNull(X_COORD_CD),X_COORD_CD==0),MedianNo0_X_COORD_CD,X_COORD_CD),",
				"          Y_COORD_CD = iif(or(isNull(Y_COORD_CD),Y_COORD_CD==0),MedianNo0_Y_COORD_CD,Y_COORD_CD),",
				"          Latitude = iif(or(isNull(Latitude),Latitude==0),MedianNo0_Latitude,Latitude),",
				"          Longitude = iif(or(isNull(Longitude),Longitude==0),MedianNo0_Longitude,Longitude),",
				"          {New Georeferenced Column} = iif(or({New Georeferenced Column}== \"NULL\", {New Georeferenced Column} == \"POINT (0 0)\"),\"POINT (\"+toString(MedianNo0_Longitude)+ \" \" + toString(MedianNo0_Latitude) + \")\" ,{New Georeferenced Column})\r",
				",",
				"          Job_ID = $Job_id_Param,",
				"          Job_load_date = currentDate()) ~> derivedColumn1",
				"derivedColumn1 select(mapColumn(",
				"          ARREST_KEY,",
				"          ARREST_DATE,",
				"          PD_CD,",
				"          PD_DESC,",
				"          KY_CD,",
				"          OFNS_DESC,",
				"          LAW_CODE,",
				"          LAW_CAT_CD,",
				"          ARREST_BORO = TransformToCleanData@ARREST_BORO,",
				"          ARREST_PRECINCT = readCSVfile@ARREST_PRECINCT,",
				"          JURISDICTION_CODE,",
				"          AGE_GROUP,",
				"          PERP_SEX,",
				"          PERP_RACE,",
				"          X_COORD_CD,",
				"          Y_COORD_CD,",
				"          Latitude,",
				"          Longitude,",
				"          NEW_GEOREFERENCED_COLUMN = {New Georeferenced Column},",
				"          Job_ID,",
				"          Job_load_date",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> RequiredColumns",
				"RequiredColumns sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> s"
			]
		}
	}
}